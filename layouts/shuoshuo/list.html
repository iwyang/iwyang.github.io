{{ define "main" }}
    <main class="main list-container">

        {{/* ğŸŒŸ æ€æ‰‹é”ï¼šåŠ ä¸€ä¸ª Wrapper æŠŠæ ‡ç­¾å’Œåˆ—è¡¨åŒ…åœ¨ä¸€èµ·ï¼Œé˜»æ–­ä¸»é¢˜é»˜è®¤ gap çš„å¹²æ‰° */}}
        <div class="shuoshuo-layout-wrapper" style="display: block; width: 100%;">
            
            <style>
                .shuoshuo-tags-nav {
                    --tab-bg: #ffffff; --tab-border: #e2e8f0; --tab-text: #64748b; 
                    --tab-active-bg: #1e90ff; --tab-active-text: #ffffff; 
                    --count-bg: #f1f5f9; --count-text: #64748b; 
                    --count-active-bg: #ffffff; --count-active-text: #1e90ff; 
                    display: flex; align-items: center; flex-wrap: wrap; gap: 10px; 
                    
                    /* ğŸŒŸ ä¿®æ”¹ç‚¹ï¼šå»æ‰è™šçº¿ï¼Œå»æ‰å†…è¾¹è·ï¼Œåªä¿ç•™çº¯ç²¹çš„ 20px å¤–è¾¹è·ï¼Œå®Œç¾å¯¹é½å¡ç‰‡é—´è·ï¼ */
                    margin-bottom: 20px !important; 
                }
                [data-scheme="dark"] .shuoshuo-tags-nav {
                    --tab-bg: rgba(255, 255, 255, 0.04); --tab-border: rgba(255, 255, 255, 0.15); --tab-text: #a1a1aa; 
                    --tab-active-bg: #1e90ff; --tab-active-text: #ffffff; 
                    --count-bg: rgba(255, 255, 255, 0.12); --count-text: #e4e4e7; 
                    --count-active-bg: #ffffff; --count-active-text: #1e90ff; 
                }
                .shuoshuo-tags-nav .filter-tab {
                    text-decoration: none; cursor: pointer; padding: 5px 12px 5px 16px; 
                    border-radius: 50px; font-size: 1.35rem; font-weight: 500; 
                    color: var(--tab-text); background: var(--tab-bg); 
                    border: 1px solid var(--tab-border); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
                    display: inline-flex; align-items: center; gap: 8px; user-select: none; line-height: 1.2;
                }
                .shuoshuo-tags-nav .filter-tab:hover {
                    border-color: #1e90ff; color: #1e90ff; background: rgba(30, 144, 255, 0.05);
                }
                .shuoshuo-tags-nav .filter-tab:active {
                    transform: scale(0.96); opacity: 0.8;
                }
                .shuoshuo-tags-nav .filter-tab.active {
                    background: var(--tab-active-bg); border-color: var(--tab-active-bg); 
                    color: var(--tab-active-text); font-weight: 600; 
                    box-shadow: 0 4px 12px rgba(30, 144, 255, 0.3); pointer-events: none;
                }
                .shuoshuo-tags-nav .filter-count {
                    font-size: 1.15rem; padding: 3px 8px; border-radius: 50px; 
                    background: var(--count-bg); color: var(--count-text); 
                    font-weight: 600; min-width: 24px; text-align: center;
                }
                .shuoshuo-tags-nav .filter-tab.active .filter-count {
                    background: var(--count-active-bg); color: var(--count-active-text);
                }
                .shuoshuo-list {
                    margin-top: 0 !important;
                }
            </style>

            <div class="shuoshuo-tags-nav">
                {{ $totalShuo := len (where .Site.RegularPages "Section" "shuoshuo") }}
                <a href="/shuoshuo/" class="filter-tab {{ if not $.Data.Term }}active{{ end }}">
                    å…¨éƒ¨ <span class="filter-count">{{ $totalShuo }}</span>
                </a>
                
                {{/* ç›´æ¥è°ƒç”¨åŸç”Ÿ Taxonomy å¹¶æŒ‰æ•°é‡é™åºæ’åˆ— */}}
                {{ range .Site.Taxonomies.shuoshuotags.ByCount }}
                    <a href="{{ .Page.RelPermalink }}" 
                       class="filter-tab {{ if eq ($.Data.Term | default "") (.Page.Title | lower) }}active{{ end }}">
                        {{ .Page.Title }} <span class="filter-count">{{ .Count }}</span>
                    </a>
                {{ end }}
            </div>

            {{/* =========================================
                 2. ç€‘å¸ƒæµå®¹å™¨åŠæ¸²æŸ“
                 ========================================= */}}
            <div class="shuoshuo-list" id="masonry-container" style="opacity: 0; transition: opacity 0.4s ease;">
                {{ $paginator := .Paginate .Pages }}
                <div class="waterfall-column" id="waterfall-left">
                    {{ range $paginator.Pages }}
                        {{ partial "shuoshuo-card-logic" . }}
                    {{ end }}
                </div>
                <div class="waterfall-column" id="waterfall-right"></div>
            </div>
            
        </div> {{/* ğŸŒŸ Wrapper ç»“æŸæ ‡ç­¾ */}}

        <div class="shuoshuo-pagination">
            {{ partial "pagination.html" . }}
        </div>

        {{ partial "footer/footer.html" . }}

        {{/* ç¯ç®±åŠè„šæœ¬ */}}
        <link rel="stylesheet" href="/css/fancybox.css" />
        <script src="/js/fancybox.umd.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const masonryContainer = document.getElementById('masonry-container');
                const leftCol = document.getElementById('waterfall-left');
                const rightCol = document.getElementById('waterfall-right');
                const masonryItems = Array.from(leftCol.querySelectorAll('.shuoshuo-card'));

                /* 1. å¤„ç†å›¾ç‰‡ç»“æ„ã€ç›¸å†Œç»‘å®šå’Œä¹å®«æ ¼å¸ƒå±€ */
                document.querySelectorAll('.shuoshuo-card').forEach((card, index) => {
                    const galleryId = 'gallery-' + index;
                    const contentImages = card.querySelectorAll('.shuoshuo-content img');
                    if (!contentImages.length) return;

                    let galleries = new Map();

                    contentImages.forEach(img => {
                        let fileName = decodeURIComponent(img.src.split('/').pop().split('?')[0].split('#')[0]) || 'å›¾ç‰‡';
                        let wrapperA = img.closest('a');

                        if (!wrapperA) {
                            wrapperA = document.createElement('a');
                            wrapperA.href = img.src;
                            img.parentNode.insertBefore(wrapperA, img);
                            wrapperA.appendChild(img);
                        }
                        
                        wrapperA.setAttribute('data-fancybox', galleryId);
                        if (!wrapperA.hasAttribute('data-caption')) wrapperA.setAttribute('data-caption', img.alt || img.title || fileName);
                        wrapperA.classList.add('shuoshuo-image');
                        
                        const imgParent = wrapperA.parentElement;
                        if (!galleries.has(imgParent)) galleries.set(imgParent, []);
                        galleries.get(imgParent).push(wrapperA);
                    });

                    galleries.forEach((wrappers, parent) => {
                        const galleryDiv = document.createElement('div');
                        galleryDiv.className = 'shuoshuo-image-gallery';
                        parent.insertBefore(galleryDiv, wrappers[0]);
                        wrappers.forEach(w => galleryDiv.appendChild(w));

                        if (parent.tagName === 'P' && parent.textContent.trim() === '') {
                            parent.parentNode.insertBefore(galleryDiv, parent);
                            parent.remove();
                        }
                    });
                });

                if (typeof Fancybox !== "undefined") {
                    Fancybox.bind('[data-fancybox^="gallery-"]', { 
                        Hash: false, 
                        Thumbs: { autoStart: false }, 
                        Toolbar: { display: { left: ["infobar"], middle: ["zoomIn", "zoomOut", "toggle1to1", "rotateCCW", "rotateCW"], right: ["slideshow", "download", "close"] } },
                        backdropClick: "close",
                        compact: false
                    });
                }

                /* 2. ç€‘å¸ƒæµå¸ƒå±€è®¡ç®— */
                function applyMasonryLayout() {
                    if (window.innerWidth <= 768) {
                        masonryItems.forEach(item => leftCol.appendChild(item));
                    } else {
                        leftCol.innerHTML = ''; rightCol.innerHTML = '';
                        masonryItems.forEach(item => {
                            (leftCol.offsetHeight <= rightCol.offsetHeight ? leftCol : rightCol).appendChild(item);
                        });
                    }
                    masonryContainer.style.opacity = 1; 
                }

                let layoutTimer;
                const debouncedLayout = () => {
                    clearTimeout(layoutTimer);
                    layoutTimer = setTimeout(applyMasonryLayout, 150);
                };

                window.addEventListener('resize', debouncedLayout);
                applyMasonryLayout();

                const images = masonryContainer.querySelectorAll('img');
                if (images.length > 0) {
                    images.forEach(img => {
                        if (!img.complete) {
                            img.addEventListener('load', debouncedLayout);
                            img.addEventListener('error', debouncedLayout);
                        }
                    });
                }

                /* 4. å¤„ç†ç›¸å¯¹æ—¶é—´ */
                const now = new Date();
                document.querySelectorAll('.shuoshuo-time, .shuoshuo-updated-time').forEach(el => {
                    const dateStr = el.getAttribute('datetime');
                    if (!dateStr) return;
                    const date = new Date(dateStr);
                    const diff = (now - date) / 1000;
                    
                    if (!el.hasAttribute('title')) {
                        const exactTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                        el.setAttribute('title', (el.classList.contains('shuoshuo-updated-time') ? "æ›´æ–°äº " : "å‘å¸ƒäº ") + exactTime);
                    }

                    let text = 'åˆšåˆš';
                    if (diff >= 31536000) text = Math.floor(diff / 31536000) + ' å¹´å‰';
                    else if (diff >= 2592000) text = Math.floor(diff / 2592000) + ' ä¸ªæœˆå‰';
                    else if (diff >= 86400) text = Math.floor(diff / 86400) + ' å¤©å‰';
                    else if (diff >= 3600) text = Math.floor(diff / 3600) + ' å°æ—¶å‰';
                    else if (diff >= 60) text = Math.floor(diff / 60) + ' åˆ†é’Ÿå‰';
                    
                    (el.querySelector('span') || el).innerText = text;
                });
            });
        </script>
    </main>
{{ end }}

{{/* --- æ ¸å¿ƒæ¨¡å…·ï¼šå¡ç‰‡æ¸²æŸ“ --- */}}
{{ define "partials/shuoshuo-card-logic" }}
{{- $gitHashFull := "" -}}
{{- $gitHashShort := "" -}}
{{- $updateTime := .Lastmod -}}

{{- if .GitInfo -}}
    {{- $gitHashFull = .GitInfo.Hash -}}
    {{- $gitHashShort = substr .GitInfo.Hash 0 7 -}}
    {{- $updateTime = .GitInfo.AuthorDate -}}
{{- end -}}

<article class="shuoshuo-card">
    <div class="shuoshuo-header">
        <div class="shuoshuo-meta meta-wrapper">
            <time class="shuoshuo-time meta-item" datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <span>{{ .Date.Format "2006-01-02" }}</span>
            </time>
            {{ if gt (sub $updateTime.Unix .Date.Unix) 1800 }}
                <span class="shuoshuo-updated-time meta-item" datetime="{{ $updateTime.Format "2006-01-02T15:04:05Z07:00" }}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    <span>{{ $updateTime.Format "2006-01-02" }}</span>
                </span>
            {{ end }}
        </div>
    </div>

    <div class="shuoshuo-content style-cs-content article-post">
        {{ .Content }}
    </div>
    
    {{ if .Params.shuoshuotags }}
    <div class="shuoshuo-tags meta-wrapper" style="margin-top: 15px !important; margin-bottom: 5px !important; gap: 10px !important;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px; color: var(--card-text-color-secondary);"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
        {{ range .Params.shuoshuotags }}
            <a href="{{ "shuoshuotags/" | relLangURL }}{{ . | urlize }}/" class="meta-item shuoshuo-tag" title="æŸ¥çœ‹æ ‡ç­¾: {{ . }}">
                <span>#{{ . }}</span>
            </a>
        {{ end }}
    </div>
    {{ end }}

    {{/* ğŸŒŸ è¿™é‡Œæ˜¯ä¿®æ”¹çš„æ ¸å¿ƒï¼šä¸º Footer æ·»åŠ é¡¶è¾¹æ¡†ï¼ŒåŒæ—¶ç»™é€‚å½“çš„å¤–è¾¹è·å’Œå†…è¾¹è·ï¼Œè¾¾åˆ°çº¢æ¡†æ ‡æ³¨çš„ä¸€è‡´è§†è§‰æ•ˆæœ */}}
    <div class="shuoshuo-footer-info" style="border-top: 1px dashed rgba(128, 128, 128, 0.15); margin-top: 12px; padding-top: 12px;">
        <div class="shuoshuo-edit-link meta-wrapper" style="gap: 15px !important;">
            {{ if and (.Site.Params.article.edit.enabled) (not (eq .Params.edit false)) }}
                <a href="https://github.com/iwyang/iwyang.github.io/edit/develop/content/{{ replace .File.Path "\\" "/" }}" target="_blank" rel="noopener noreferrer" class="meta-item" title="å‰å¾€ GitHub ç¼–è¾‘æ­¤é¡µ">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                    <span>ç¼–è¾‘æ­¤é¡µ</span>
                </a>
                {{- if $gitHashShort -}}<span class="separator" style="color: #1e90ff;">|</span>{{- end -}}
            {{ end }}
            {{- if $gitHashShort -}}
                <a class="meta-item git-hash-text" href="https://github.com/iwyang/iwyang.github.io/commit/{{ $gitHashFull }}" target="_blank" rel="noopener noreferrer" title="Commit Hash: {{ $gitHashShort }}">
                   #{{ $gitHashShort }}
                </a>
            {{- end -}}
            <span class="separator" style="color: #1e90ff;">|</span>
            <a class="meta-item git-hash-text" href="{{ .RelPermalink }}" title="æŸ¥çœ‹åŸæ–‡é“¾æ¥">
                åŸæ–‡é“¾æ¥
            </a>
        </div>
    </div>
</article>
{{ end }}