{{ define "main" }}
    <main class="main list-container">
        
        <div class="shuoshuo-list">
            {{ $paginator := .Paginate .Pages }}
            
            <div class="waterfall-column">
                {{ range $index, $element := $paginator.Pages }}
                    {{ if eq (mod $index 2) 0 }}
                        {{ partial "shuoshuo-card-logic" . }}
                    {{ end }}
                {{ end }}
            </div>

            <div class="waterfall-column">
                {{ range $index, $element := $paginator.Pages }}
                    {{ if eq (mod $index 2) 1 }}
                        {{ partial "shuoshuo-card-logic" . }}
                    {{ end }}
                {{ end }}
            </div>
        </div>

        <div class="shuoshuo-pagination">
            {{ partial "pagination.html" . }}
        </div>

        {{ partial "footer/footer.html" . }}

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const now = new Date();

                // 1. 处理发布时间 (保持原逻辑不变)
                const timeElements = document.querySelectorAll('.shuoshuo-time');
                timeElements.forEach(el => {
                    const dateStr = el.getAttribute('datetime');
                    if (!dateStr) return;
                    const date = new Date(dateStr);
                    const diff = (now - date) / 1000;
                    const textSpan = el.querySelector('.date-text');
                    if (!textSpan) return;

                    // 格式化 Title
                    const exactTime = formatExactTime(date);
                    el.setAttribute('title', exactTime);

                    // 计算相对时间
                    textSpan.innerText = getRelativeTime(diff);
                });

                // 2. 新增：处理更新时间 (Lastmod)
                const lastmodElements = document.querySelectorAll('.git-lastmod-time');
                lastmodElements.forEach(el => {
                    const dateStr = el.getAttribute('datetime');
                    if (!dateStr) return;
                    const date = new Date(dateStr);
                    const diff = (now - date) / 1000;

                    // 格式化 Title (显示为 2026-02-14 09:50)
                    const exactTime = formatExactTime(date);
                    el.setAttribute('title', exactTime);

                    // 计算相对时间并更新文本
                    el.innerText = getRelativeTime(diff);
                });

                // --- 辅助函数：格式化时间 (YYYY-MM-DD HH:mm) ---
                function formatExactTime(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hour = String(date.getHours()).padStart(2, '0');
                    const minute = String(date.getMinutes()).padStart(2, '0');
                    return year + '-' + month + '-' + day + ' ' + hour + ':' + minute;
                }

                // --- 辅助函数：计算相对时间 ---
                function getRelativeTime(diff) {
                    if (diff < 60) { return '刚刚'; }
                    else if (diff < 3600) { return Math.floor(diff / 60) + ' 分钟前'; }
                    else if (diff < 86400) { return Math.floor(diff / 3600) + ' 小时前'; }
                    else if (diff < 2592000) { return Math.floor(diff / 86400) + ' 天前'; }
                    else if (diff < 31536000) { return Math.floor(diff / 2592000) + ' 个月前'; }
                    else { return Math.floor(diff / 31536000) + ' 年前'; }
                }
            });
        </script>
    </main>
{{ end }}

{{/* --- 核心模具 --- */}}
{{ define "partials/shuoshuo-card-logic" }}
<article class="shuoshuo-card">
    <div class="shuoshuo-header">
        <div class="shuoshuo-meta">
            <time class="shuoshuo-time" datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                {{ partial "helper/icon" "date" }}
                <span class="date-text">{{ .Date.Format "2006-01-02" }}</span>
            </time>
        </div>
    </div>

    <div class="shuoshuo-content style-cs-content article-post">
        {{ .Content }}
    </div>
    
    {{ with .Resources.GetMatch "cover.*" }}
    <div class="shuoshuo-image photo-gallery">
        <a href="{{ .RelPermalink }}" target="_blank" class="gallery-link">
            <img src="{{ .RelPermalink }}" loading="lazy" alt="说说图片" style="border-radius: 8px; margin-top: 10px; width: 100%; height: auto; object-fit: cover;">
        </a>
    </div>
    {{ end }}

    <div class="shuoshuo-footer-info">
        {{ if and (.Site.Params.article.edit.enabled) (not (eq .Params.edit false)) }}
        <div class="shuoshuo-edit-link">
            {{ partial "helper/icon" "external-link" }}
            {{/* 修改处1：添加了 text-decoration: none; 去除下划线 */}}
            <a href="https://github.com/iwyang/iwyang.github.io/edit/develop/content/{{ replace .File.Path "\\" "/" }}" 
               target="_blank" 
               rel="noopener noreferrer" 
               style="color: inherit; text-decoration: none;">
                在 GitHub 上编辑此页
            </a>
        </div>
        {{ end }}

        {{- if .Lastmod -}}
        <div class="shuoshuo-git-info">
            {{ partial "helper/icon" "clock" }}
            <span style="color: #999;">
                更新于 
                {{/* 修改处2：添加 span class 和 datetime 属性，用于 JS 计算相对时间 */}}
                <span class="git-lastmod-time" datetime="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">
                    {{ .Lastmod.Format "2006-01-02 15:04" }}
                </span>
                
                {{- if .GitInfo -}}
                    <a href="https://github.com/iwyang/iwyang.github.io/commit/{{ .GitInfo.Hash }}" target="_blank" rel="noopener noreferrer" style="color: #1e90ff; font-weight: normal; margin-left: 5px; text-decoration: none;">
                       #{{ substr .GitInfo.Hash 0 7 }}
                    </a>
                {{- end -}}
            </span>
        </div>
        {{- end -}}
    </div>
</article>
{{ end }}