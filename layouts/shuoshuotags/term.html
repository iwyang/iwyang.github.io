{{ define "main" }}
    <main class="main list-container">

        <style>
            /* =========================================
               Êñ∞Â¢ûÔºöËØ¥ËØ¥‰∏ìÂ±ûÊ†áÁ≠æÂØºËà™Ê†èÊ†∑Âºè
               ========================================= */
            .shuoshuo-tags-nav {
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                margin-top: 0px;      
                margin-bottom: 15px;  
            }
            .shuoshuo-tags-nav a {
                display: inline-flex;
                align-items: center;
                padding: 6px 16px;
                border-radius: 20px;
                background: var(--card-background); 
                color: var(--card-text-color-secondary);
                font-size: 14px;
                text-decoration: none;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0,0,0,0.04);
                border: 1px solid transparent;
            }
            .shuoshuo-tags-nav a:hover {
                color: #1e90ff;
                border-color: #1e90ff;
            }
            .shuoshuo-tags-nav a.active {
                background: #1e90ff;
                color: #fff !important;
                border-color: #1e90ff;
                box-shadow: 0 4px 8px rgba(30,144,255,0.3);
            }
            .shuoshuo-tags-nav a .tag-count {
                margin-left: 4px;
                font-size: 12px;
                opacity: 0.9;
            }

            /* =========================================
               Áªü‰∏ÄÂÖÉÊï∞ÊçÆÊ†∑Âºè (ËØ¥ËØ¥Âç°Áâá)
               ========================================= */
            .meta-wrapper {
                display: flex !important;
                align-items: center !important;
                flex-wrap: wrap !important;
                line-height: 1 !important; 
                gap: 20px !important;      
            }
            .meta-item, 
            .shuoshuo-edit-link a,
            .shuoshuo-time,
            .shuoshuo-updated-time {
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                font-size: 14px !important;     
                line-height: 1 !important;
                text-decoration: none;
                margin: 0 !important;
                padding: 0 !important;
                border: 0 !important;
                background: none !important;
                color: var(--card-text-color-secondary) !important; 
                opacity: 1 !important; 
                -webkit-tap-highlight-color: transparent !important;
                outline: none !important;
            }
            .shuoshuo-meta svg, 
            .shuoshuo-edit-link svg,
            .shuoshuo-time svg,
            .shuoshuo-updated-time svg {
                width: 14px !important;       
                height: 14px !important;      
                min-width: 14px !important;   
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
                position: static !important;
                transform: none !important;
                opacity: 1 !important;   
                color: inherit !important;              
            }
            .meta-item span, 
            .meta-item time, 
            .shuoshuo-updated-time span,
            .shuoshuo-edit-link span {
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
                line-height: 1 !important;    
                font-size: 14px !important;   
                font-family: inherit;
                font-weight: normal !important;
                color: inherit !important;
            }
            .shuoshuo-edit-link a,
            .shuoshuo-edit-link .git-hash-text {
                color: #1e90ff !important;
                transition: opacity 0.3s ease;
            }
            .shuoshuo-edit-link .separator {
                color: #1e90ff !important;
                opacity: 1 !important;
            }
            .shuoshuo-edit-link a:hover {
                opacity: 0.7 !important;
                text-decoration: underline;
            }
            .shuoshuo-tag {
                transition: color 0.3s ease, opacity 0.3s ease;
            }
            .shuoshuo-tag:hover {
                color: #1e90ff !important;
                opacity: 0.8 !important;
            }
        </style>

        {{/* =========================================
             1. Êô∫ËÉΩËÆ°ÁÆóËØ¥ËØ¥‰∏ìÂ±ûÊ†áÁ≠æÊï∞Èáè (Êï∞ÊçÆÊ∫êÊîπ‰∏∫ shuoshuotags)
             ========================================= */}}
        {{ $.Scratch.Set "shuoTagsCount" dict }}
        {{ range where .Site.RegularPages "Section" "shuoshuo" }}
            {{ range .Params.shuoshuotags }}
                {{ $t := . | lower }}
                {{ $dict := $.Scratch.Get "shuoTagsCount" }}
                {{ if isset $dict $t }}
                    {{ $.Scratch.SetInMap "shuoTagsCount" $t (add (index $dict $t) 1) }}
                {{ else }}
                    {{ $.Scratch.SetInMap "shuoTagsCount" $t 1 }}
                {{ end }}
            {{ end }}
        {{ end }}

        {{/* =========================================
             2. Â∞ÜÂ≠óÂÖ∏ËΩ¨‰∏∫ÂèØÊéíÂ∫èÁöÑÊï∞ÁªÑ (Slice)
             ========================================= */}}
        {{ $.Scratch.Set "shuoTagsSlice" slice }}
        {{ range $name, $taxonomy := .Site.Taxonomies.shuoshuotags }}
            {{ $shuoCount := index ($.Scratch.Get "shuoTagsCount") ($name | lower) }}
            {{ if $shuoCount }}
                {{ $.Scratch.Add "shuoTagsSlice" (dict "name" $name "count" $shuoCount) }}
            {{ end }}
        {{ end }}

        {{/* =========================================
             3. Ê∏≤ÊüìÈ°∂ÈÉ®ÂØºËà™Ê†è 
             ========================================= */}}
        <div class="shuoshuo-tags-nav">
            {{ $totalShuo := len (where .Site.RegularPages "Section" "shuoshuo") }}
            <a href="/shuoshuo/" class="{{ if not $.Data.Term }}active{{ end }}">
                üè∑Ô∏è ÂÖ®ÈÉ® <span class="tag-count">{{ $totalShuo }}</span>
            </a>
            
            {{ $sortedTags := sort ($.Scratch.Get "shuoTagsSlice") "count" "desc" }}
            
            {{ range $sortedTags }}
                {{/* Ë∑ØÁî±Ë∑ØÂæÑÊõ¥Êñ∞‰∏∫ shuoshuotags */}}
                <a href="{{ "/shuoshuotags/" | relLangURL }}{{ .name | urlize }}/" 
                   class="{{ if eq ($.Data.Term | default "") (.name | lower) }}active{{ end }}">
                    #{{ .name }} <span class="tag-count">{{ .count }}</span>
                </a>
            {{ end }}
        </div>

        {{/* =========================================
             4. ÁÄëÂ∏ÉÊµÅÂÆπÂô®ÂèäÊ∏≤Êüì
             ========================================= */}}
        <div class="shuoshuo-list" id="masonry-container" style="opacity: 0; transition: opacity 0.4s ease;">
            {{ $paginator := .Paginate .Pages }}
            
            <div class="waterfall-column" id="waterfall-left">
                {{ range $paginator.Pages }}
                    {{ partial "shuoshuo-card-logic" . }}
                {{ end }}
            </div>

            <div class="waterfall-column" id="waterfall-right"></div>
        </div>

        <div class="shuoshuo-pagination">
            {{ partial "pagination.html" . }}
        </div>

        {{ partial "footer/footer.html" . }}

        {{/* ÁÅØÁÆ±ÂèäËÑöÊú¨ */}}
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const masonryContainer = document.getElementById('masonry-container');
                const leftCol = document.getElementById('waterfall-left');
                const rightCol = document.getElementById('waterfall-right');
                const masonryItems = Array.from(leftCol.querySelectorAll('.shuoshuo-card'));

                function applyMasonryLayout() {
                    if (window.innerWidth <= 768) {
                        masonryItems.forEach(item => leftCol.appendChild(item));
                        masonryContainer.style.opacity = 1;
                        return;
                    }
                    leftCol.innerHTML = '';
                    rightCol.innerHTML = '';
                    masonryItems.forEach(item => {
                        if (leftCol.offsetHeight <= rightCol.offsetHeight) leftCol.appendChild(item);
                        else rightCol.appendChild(item);
                    });
                    masonryContainer.style.opacity = 1;
                }

                applyMasonryLayout();
                window.addEventListener('resize', applyMasonryLayout);

                const images = masonryContainer.querySelectorAll('img');
                let loadedCount = 0;
                if (images.length > 0) {
                    images.forEach(img => {
                        if (img.complete) { loadedCount++; if (loadedCount === images.length) applyMasonryLayout(); } 
                        else {
                            img.addEventListener('load', () => { loadedCount++; if (loadedCount === images.length) applyMasonryLayout(); });
                            img.addEventListener('error', () => { loadedCount++; if (loadedCount === images.length) applyMasonryLayout(); });
                        }
                    });
                } else { masonryContainer.style.opacity = 1; }

                /* =========================================
                   Ê†∏ÂøÉ‰øÆÂ§çÔºöÊåâËØ¥ËØ¥Âç°ÁâáÁã¨Á´ãÂàíÂàÜÁõ∏ÂÜå ID
                   ========================================= */
                const shuoshuoCards = document.querySelectorAll('.shuoshuo-card');
                
                shuoshuoCards.forEach((card, index) => {
                    // ‰∏∫ÂΩìÂâçËøôÊù°ËØ¥ËØ¥ÁîüÊàêÂîØ‰∏ÄÁöÑÁõ∏ÂÜå ID
                    const galleryId = 'gallery-' + index;
                    const contentImages = card.querySelectorAll('.shuoshuo-content img');
                    
                    contentImages.forEach(img => {
                        let fileName = img.src.split('/').pop().split('?')[0].split('#')[0];
                        try { fileName = decodeURIComponent(fileName); } catch (e) {}
                        fileName = fileName || 'ÂõæÁâá';

                        const parent = img.parentElement;
                        if (parent.tagName === 'A') {
                            // Áõ¥Êé•Ë¶ÜÁõñÊàñËÆæÁΩÆ data-fancybox Â±ûÊÄß‰∏∫ÂΩìÂâçÁõ∏ÂÜå ID
                            parent.setAttribute('data-fancybox', galleryId);
                            if (!parent.hasAttribute('data-caption')) {
                                parent.setAttribute('data-caption', img.alt || img.title || fileName);
                            }
                            parent.classList.add('shuoshuo-image');
                            parent.style.display = 'block';
                        } else {
                            const a = document.createElement('a');
                            a.href = img.src;
                            a.setAttribute('data-fancybox', galleryId);
                            a.setAttribute('data-caption', img.alt || img.title || fileName);
                            a.classList.add('shuoshuo-image');
                            a.style.display = 'block';
                            img.parentNode.insertBefore(a, img);
                            a.appendChild(img);
                        }
                    });
                });

                if (typeof Fancybox !== "undefined") {
                    // ‰øÆÊîπÁªëÂÆöÈÄªËæëÔºöÂåπÈÖçÊâÄÊúâ‰ª• gallery- ÂºÄÂ§¥ÁöÑ data-fancybox
                    Fancybox.bind('[data-fancybox^="gallery-"]', { 
                        Hash: false, 
                        Thumbs: { autoStart: false }, 
                        Toolbar: { 
                            display: { 
                                left: ["infobar"], 
                                middle: ["zoomIn", "zoomOut", "toggle1to1", "rotateCCW", "rotateCW"], 
                                right: ["slideshow", "download", "close"], 
                            }, 
                        }, 
                    });
                }

                const now = new Date();
                const timeElements = document.querySelectorAll('.shuoshuo-time, .shuoshuo-updated-time');
                timeElements.forEach(el => updateTimeDisplay(el, now));

                function updateTimeDisplay(el, now) {
                    const dateStr = el.getAttribute('datetime');
                    if (!dateStr) return;
                    const date = new Date(dateStr);
                    const diff = (now - date) / 1000;
                    const textSpan = el.querySelector('span') || el;
                    const exactTime = formatExactTime(date);
                    if (!el.hasAttribute('title')) {
                        const prefix = el.classList.contains('shuoshuo-updated-time') ? "Êõ¥Êñ∞‰∫é " : "ÂèëÂ∏É‰∫é ";
                        el.setAttribute('title', prefix + exactTime);
                    }
                    textSpan.innerText = getRelativeTime(diff);
                }

                function formatExactTime(date) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hour = String(date.getHours()).padStart(2, '0');
                    const minute = String(date.getMinutes()).padStart(2, '0');
                    return year + '-' + month + '-' + day + ' ' + hour + ':' + minute;
                }

                function getRelativeTime(diff) {
                    if (diff < 60) return 'ÂàöÂàö';
                    else if (diff < 3600) return Math.floor(diff / 60) + ' ÂàÜÈíüÂâç';
                    else if (diff < 86400) return Math.floor(diff / 3600) + ' Â∞èÊó∂Ââç';
                    else if (diff < 2592000) return Math.floor(diff / 86400) + ' Â§©Ââç';
                    else if (diff < 31536000) return Math.floor(diff / 2592000) + ' ‰∏™ÊúàÂâç';
                    else return Math.floor(diff / 31536000) + ' Âπ¥Ââç';
                }
            });
        </script>
    </main>
{{ end }}

{{/* --- Ê†∏ÂøÉÊ®°ÂÖ∑ÔºöÂç°ÁâáÊ∏≤Êüì --- */}}
{{ define "partials/shuoshuo-card-logic" }}
{{- $gitHashFull := "" -}}
{{- $gitHashShort := "" -}}
{{- $updateTime := .Lastmod -}}

{{- if .GitInfo -}}
    {{- $gitHashFull = .GitInfo.Hash -}}
    {{- $gitHashShort = substr .GitInfo.Hash 0 7 -}}
    {{- $updateTime = .GitInfo.AuthorDate -}}
{{- end -}}

<article class="shuoshuo-card">
    <div class="shuoshuo-header">
        <div class="shuoshuo-meta meta-wrapper">
            <time class="shuoshuo-time meta-item" datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <span>{{ .Date.Format "2006-01-02" }}</span>
            </time>
            {{ $created := .Date.Unix }}
            {{ $updated := $updateTime.Unix }}
            {{ $diff := sub $updated $created }}
            {{ if gt $diff 1800 }}
                <span class="shuoshuo-updated-time meta-item" datetime="{{ $updateTime.Format "2006-01-02T15:04:05Z07:00" }}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    <span>{{ $updateTime.Format "2006-01-02" }}</span>
                </span>
            {{ end }}
        </div>
    </div>

    <div class="shuoshuo-content style-cs-content article-post">
        {{ .Content }}
    </div>
    
    {{ if .Params.shuoshuotags }}
    <div class="shuoshuo-tags meta-wrapper" style="margin-top: 15px !important; margin-bottom: 5px !important; gap: 10px !important;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 14px; height: 14px; color: var(--card-text-color-secondary);"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
        {{ range .Params.shuoshuotags }}
            <a href="{{ "shuoshuotags/" | relLangURL }}{{ . | urlize }}/" class="meta-item shuoshuo-tag" title="Êü•ÁúãÊ†áÁ≠æ: {{ . }}">
                <span>#{{ . }}</span>
            </a>
        {{ end }}
    </div>
    {{ end }}

    <div class="shuoshuo-footer-info">
        <div class="shuoshuo-edit-link meta-wrapper" style="gap: 15px !important;">
            {{ if and (.Site.Params.article.edit.enabled) (not (eq .Params.edit false)) }}
                <a href="https://github.com/iwyang/iwyang.github.io/edit/develop/content/{{ replace .File.Path "\\" "/" }}" target="_blank" rel="noopener noreferrer" class="meta-item" title="ÂâçÂæÄ GitHub ÁºñËæëÊ≠§È°µ">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                    <span>ÁºñËæëÊ≠§È°µ</span>
                </a>
            {{ end }}
            {{- if $gitHashShort -}}
                {{ if and (.Site.Params.article.edit.enabled) (not (eq .Params.edit false)) }}
                    <span class="separator">|</span>
                {{ end }}
                <a class="meta-item git-hash-text" href="https://github.com/iwyang/iwyang.github.io/commit/{{ $gitHashFull }}" target="_blank" rel="noopener noreferrer" title="Commit Hash: {{ $gitHashShort }}">
                   #{{ $gitHashShort }}
                </a>
            {{- end -}}
        </div>
    </div>
</article>
{{ end }}