name: Push to Dropbox (Develop Branch Only)

on:
  push:
    branches:
      - develop
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 修正后的打包步骤：增加了对 backup.tar.gz 本身的排除
      - name: Create Archive
        run: tar -czf backup.tar.gz --exclude='.git' --exclude='backup.tar.gz' .

      - name: Refresh Dropbox Token
        id: dropbox_auth
        run: |
          RESPONSE=$(curl https://api.dropbox.com/oauth2/token \
            -d grant_type=refresh_token \
            -d refresh_token=${{ secrets.DROPBOX_REFRESH_TOKEN }} \
            -u ${{ secrets.DROPBOX_APP_KEY }}:${{ secrets.DROPBOX_APP_SECRET }})
          
          TOKEN=$(echo $RESPONSE | jq -r '.access_token')
          echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Upload to Dropbox
        run: |
          curl -X POST https://content.dropboxapi.com/2/files/upload \
            --header "Authorization: Bearer ${{ env.ACCESS_TOKEN }}" \
            --header "Dropbox-API-Arg: {\"path\": \"/资料/文档/个人/latest_backup.tar.gz\",\"mode\": \"overwrite\",\"autorename\": false,\"mute\": true}" \
            --header "Content-Type: application/octet-stream" \
            --data-binary @backup.tar.gz