name: Push to Dropbox (Specific Personal Folder)

on:
  push:
    branches:
      - develop  # 仅在 develop 分支提交时触发
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 创建 ZIP 压缩包
      # 排除了 .git 文件夹，且生成在项目目录之外，防止“文件变动”报错
      - name: Create Zip Archive
        run: zip -r ../backup.zip . -x "*.git*"

      # 3. 使用 Refresh Token 获取临时的 Access Token
      - name: Refresh Dropbox Token
        id: dropbox_auth
        run: |
          RESPONSE=$(curl https://api.dropbox.com/oauth2/token \
            -d grant_type=refresh_token \
            -d refresh_token=${{ secrets.DROPBOX_REFRESH_TOKEN }} \
            -u ${{ secrets.DROPBOX_APP_KEY }}:${{ secrets.DROPBOX_APP_SECRET }})
          
          TOKEN=$(echo $RESPONSE | jq -r '.access_token')
          echo "ACCESS_TOKEN=$TOKEN" >> $GITHUB_ENV

      # 4. 上传到指定的深层目录并覆盖
      - name: Upload to Dropbox
        run: |
          # 目标路径设定为：/资料/文档/个人/hugo blog backup/latest_backup.zip
          curl -X POST https://content.dropboxapi.com/2/files/upload \
            --header "Authorization: Bearer ${{ env.ACCESS_TOKEN }}" \
            --header "Dropbox-API-Arg: {\"path\": \"/资料/文档/个人/hugo blog backup/latest_backup.zip\",\"mode\": \"overwrite\",\"autorename\": false,\"mute\": true}" \
            --header "Content-Type: application/octet-stream" \
            --data-binary @../backup.zip